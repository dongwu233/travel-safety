<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è¡Œå®‰å…¨ä¸­å¿ƒ - äº‘åŒæ­¥ç‰ˆ</title>
    <!-- React & Babel for direct browser running -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #F8FAF9; font-family: -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        #root { min-height: 100vh; }
        * { box-sizing: border-box; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: .5; transform: scale(1.3); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
    </style>
    <!-- ä¿®å¤ï¼šç§»é™¤é‡å¤çš„ base æ ‡ç­¾ -->
    <base target="_blank">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect, useMemo } = React;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ğŸ” å¯†ç é…ç½®åŒº â€” éƒ¨ç½²å‰åœ¨è¿™é‡Œä¿®æ”¹ä¸¤ä¸ªå¯†ç 
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const VIEWER_PASSWORD = "travel2026";   // å®¶äºº/æœ‹å‹æŸ¥çœ‹å¯†ç 
        const ADMIN_PASSWORD  = "admin888";     // ä½ è‡ªå·±çš„ç®¡ç†å‘˜å¯†ç ï¼ˆå¯ç¼–è¾‘è¡Œç¨‹ï¼‰

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ğŸ“… é»˜è®¤è¡Œç¨‹æ•°æ®
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DEFAULT_ITINERARY = [
          { id:1, country:"è¶Šå— Â· æ²³å†…",      flag:"ğŸ‡»ğŸ‡³", dates:"2æœˆ17æ—¥â€”2æœˆ20æ—¥", status:"done", arriveDate:"2026-02-17", lat:21.0285, lng:105.8542 },
          { id:2, country:"è¶Šå— Â· èƒ¡å¿—æ˜å¸‚",  flag:"ğŸ‡»ğŸ‡³", dates:"2æœˆ21æ—¥â€”2æœˆ23æ—¥", status:"done", arriveDate:"2026-02-21", lat:10.7769, lng:106.7009 },
          { id:3, country:"æ³°å›½ Â· æ›¼è°·",      flag:"ğŸ‡¹ğŸ‡­", dates:"2æœˆ24æ—¥â€”3æœˆ1æ—¥",  status:"now",  arriveDate:"2026-02-24", lat:13.7563, lng:100.5018 },
          { id:4, country:"é©¬æ¥è¥¿äºš Â· å‰éš†å¡",flag:"ğŸ‡²ğŸ‡¾", dates:"3æœˆ2æ—¥â€”3æœˆ4æ—¥",   status:"next", arriveDate:"2026-03-02", lat:3.1390, lng:101.6869 },
          { id:5, country:"æ–°åŠ å¡",            flag:"ğŸ‡¸ğŸ‡¬", dates:"3æœˆ5æ—¥â€”3æœˆ7æ—¥",   status:"next", arriveDate:"2026-03-05", lat:1.3521, lng:103.8198 },
        ];
        const DEFAULT_PERSONAL = { name:"", passport:"", blood:"Aå‹", allergy:"æ— ", contact:"", insurance:"", insPhone:"", returnDate:"2026-03-07" };
        const DEFAULT_SETTINGS = { interval:"24", contactName:"å¦ˆå¦ˆ", contactPhone:"+86 138****8888" };
        const INIT_LOGS = [
          { 
            id: 1, 
            loc:"æ›¼è°·", 
            msg:"ä¸€åˆ‡éƒ½å¥½ï¼Œä»Šå¤©å»äº†å¤§çš‡å®«ï¼", 
            time:"2æœˆ24æ—¥ 09:32", 
            country:"æ³°å›½", 
            lat:13.7500, 
            lng:100.4913, 
            photo:null, 
            likes: 3, 
            comments: [
              { id: 101, text: "æ³¨æ„å®‰å…¨ï¼Œç©å¾—å¼€å¿ƒï¼", time:"2æœˆ24æ—¥ 10:15", author: "å¦ˆå¦ˆ" },
              { id: 102, text: "å¤§çš‡å®«å¾ˆæ¼‚äº®ï¼Œå¤šæ‹ç‚¹ç…§ç‰‡", time:"2æœˆ24æ—¥ 11:20", author: "çˆ¸çˆ¸" }
            ] 
          },
        ];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  â˜ï¸ GitHub Gist åŒæ­¥é…ç½®ä¸å·¥å…·
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Gist å­˜å‚¨é”®å
        const GIST_FILENAME = "travel-safety-data.json";

        // æ•°æ®ç‰ˆæœ¬æ§åˆ¶ï¼ˆç”¨äºè¿ç§»ï¼‰
        const DATA_VERSION = "1.0";

        // åŠ è½½æœ¬åœ°å­˜å‚¨ï¼ˆå¸¦ç‰ˆæœ¬æ£€æŸ¥ï¼‰
        function loadFromStorage(key, fallback) {
          try { 
            const v = localStorage.getItem(key); 
            if (!v) return fallback;
            const parsed = JSON.parse(v);
            // æ£€æŸ¥æ•°æ®ç‰ˆæœ¬
            if (parsed && parsed._version === DATA_VERSION) {
              return parsed.data !== undefined ? parsed.data : parsed;
            }
            return parsed;
          } catch { return fallback; }
        }

        function saveToStorage(key, val) {
          try { 
            localStorage.setItem(key, JSON.stringify({ _version: DATA_VERSION, data: val })); 
          } catch {}
        }

        // Gist API å·¥å…·å‡½æ•°
        const GistAPI = {
          // è·å– Gist å†…å®¹
          async fetchGist(gistId, token) {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            if (!response.ok) throw new Error(`è·å–å¤±è´¥: ${response.status}`);
            const gist = await response.json();
            const file = gist.files[GIST_FILENAME];
            if (!file) throw new Error('æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
            return JSON.parse(file.content);
          },

          // æ›´æ–° Gist
          async updateGist(gistId, token, data) {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
              method: 'PATCH',
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                files: {
                  [GIST_FILENAME]: {
                    content: JSON.stringify(data, null, 2)
                  }
                }
              })
            });
            if (!response.ok) throw new Error(`åŒæ­¥å¤±è´¥: ${response.status}`);
            return await response.json();
          },

          // åˆ›å»ºæ–° Gist
          async createGist(token, data) {
            const response = await fetch('https://api.github.com/gists', {
              method: 'POST',
              headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                description: 'æ—…è¡Œå®‰å…¨ä¸­å¿ƒæ•°æ®å¤‡ä»½',
                public: false, // ç§å¯† Gist
                files: {
                  [GIST_FILENAME]: {
                    content: JSON.stringify(data, null, 2)
                  }
                }
              })
            });
            if (!response.ok) throw new Error(`åˆ›å»ºå¤±è´¥: ${response.status}`);
            return await response.json();
          }
        };

        // â”€â”€ åœ°å›¾ç»„ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function StaticMap({ lat, lng, zoom=14, height=160 }) {
          if (!lat || !lng) return null;
          const sz = 256;
          const n = Math.pow(2, zoom);
          const tX = Math.floor(((lng + 180) / 360) * n);
          const tY = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * n);
          const tiles = [];
          for (let dy = -1; dy <= 1; dy++) for (let dx = -1; dx <= 1; dx++) tiles.push({ x: tX + dx, y: tY + dy, dx, dy });
          const fx = ((lng + 180) / 360) * n - tX, fy = (1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * n - tY;
          const ox = -(fx - 0.5) * sz, oy = -(fy - 0.5) * sz;
          return (
            <div style={{width:"100%", height, borderRadius:12, overflow:"hidden", position:"relative", background:"#e8f4ea", border:"1px solid #C8E6C9"}}>
              <div style={{position:"absolute", left:"50%", top:"50%", width:sz*3, height:sz*3, transform:`translate(calc(-50% + ${ox}px), calc(-50% + ${oy}px))`}}>
                {tiles.map(({x, y, dx, dy}) => (
                  <img key={`${dx}-${dy}`} src={`https://tile.openstreetmap.org/${zoom}/${x}/${y}.png`} alt=""
                    style={{position:"absolute", left:(dx+1)*sz, top:(dy+1)*sz, width:sz, height:sz, display:"block"}}
                    onError={e => { e.target.style.opacity = 0; }} />
                ))}
              </div>
              <div style={{position:"absolute", left:"50%", top:"50%", transform:"translate(-50%, -100%)", pointerEvents:"none", zIndex:10}}>
                <div style={{width:24, height:24, borderRadius:"50% 50% 50% 0", transform:"rotate(-45deg)", background:"#FF6B35", boxShadow:"0 3px 10px rgba(0,0,0,.35)", display:"flex", alignItems:"center", justifyContent:"center"}}>
                  <span style={{transform:"rotate(45deg)", color:"white", fontSize:11, fontWeight:700}}>â˜…</span>
                </div>
              </div>
            </div>
          );
        }

        // â”€â”€ åœ°å›¾é€‰æ‹©å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function MapPicker({ initLat=13.75, initLng=100.49, onPick }) {
          const [center,setCenter]=useState({lat:initLat,lng:initLng});
          const [zoom,setZoom]=useState(13);
          const [dragging,setDragging]=useState(false);
          const [dragStart,setDragStart]=useState(null);
          const sz=256;
          const toTile=(la,ln,z)=>{const n=Math.pow(2,z);return{x:((ln+180)/360)*n,y:(1-Math.log(Math.tan(la*Math.PI/180)+1/Math.cos(la*Math.PI/180))/Math.PI)/2*n};};
          const toLL=(tx,ty,z)=>{const n=Math.pow(2,z);return{lat:Math.atan(Math.sinh(Math.PI*(1-2*ty/n)))*180/Math.PI,lng:(tx/n)*360-180};};
          const ct=toTile(center.lat,center.lng,zoom);
          const tX=Math.floor(ct.x),tY=Math.floor(ct.y);
          const ox=-(ct.x-tX-0.5)*sz, oy=-(ct.y-tY-0.5)*sz;
          const tiles=[]; for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++) tiles.push({x:tX+dx,y:tY+dy,dx,dy});
          const onDown=e=>{setDragging(true);setDragStart({x:e.clientX,y:e.clientY,lat:center.lat,lng:center.lng});e.preventDefault();};
          const onMove=useCallback(e=>{
            if(!dragging||!dragStart)return;
            const dx=e.clientX-dragStart.x,dy=e.clientY-dragStart.y,n=Math.pow(2,zoom);
            const st=toTile(dragStart.lat,dragStart.lng,zoom);
            const newLat=toLL(st.x,st.y+dy/sz,zoom).lat;
            setCenter({lat:Math.max(-85,Math.min(85,newLat)),lng:dragStart.lng-(dx/sz)*(360/n)});
          },[dragging,dragStart,zoom]);
          const onUp=()=>setDragging(false);
          useEffect(()=>{window.addEventListener("mousemove",onMove);window.addEventListener("mouseup",onUp);return()=>{window.removeEventListener("mousemove",onMove);window.removeEventListener("mouseup",onUp);};},[onMove]);
          return (
            <div style={{marginBottom:12}}>
              <div style={{fontSize:11,color:"#6B7280",marginBottom:6}}>æ‹–åŠ¨åœ°å›¾ï¼Œå°†çº¢é’ˆå¯¹å‡†ä½ çš„ä½ç½®</div>
              <div style={{width:"100%",height:180,borderRadius:12,overflow:"hidden",position:"relative",background:"#e8f4ea",border:"1px solid #C8E6C9",cursor:dragging?"grabbing":"grab"}}
                onMouseDown={onDown}>
                <div style={{position:"absolute",left:"50%",top:"50%",width:sz*5,height:sz*5,transform:`translate(calc(-50% + ${ox}px),calc(-50% + ${oy}px))`,pointerEvents:"none"}}>
                  {tiles.map(({x,y,dx,dy})=>(
                    <img key={`${dx}-${dy}`} src={`https://tile.openstreetmap.org/${zoom}/${x}/${y}.png`} alt=""
                      style={{position:"absolute",left:(dx+2)*sz,top:(dy+2)*sz,width:sz,height:sz,display:"block"}} draggable={false}/>
                  ))}
                </div>
                <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%,-100%)",pointerEvents:"none",zIndex:20}}>
                  <div style={{width:26,height:26,borderRadius:"50% 50% 50% 0",transform:"rotate(-45deg)",background:"#E63946",boxShadow:"0 4px 12px rgba(230,57,70,.5)",display:"flex",alignItems:"center",justifyContent:"center"}}>
                    <span style={{transform:"rotate(45deg)",color:"white",fontSize:12,fontWeight:700}}>âœ¦</span>
                  </div>
                </div>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:8,padding:"8px 12px",background:"#F3F4F6",borderRadius:10,fontSize:11,color:"#6B7280"}}>
                <span>ğŸ“ {center.lat.toFixed(4)}, {center.lng.toFixed(4)}</span>
                <button onClick={()=>onPick(center.lat,center.lng)} style={{background:"#2D6A4F",color:"white",border:"none",borderRadius:8,padding:"6px 14px",fontSize:11,fontWeight:700,cursor:"pointer"}}>ç¡®è®¤ä½ç½®</button>
              </div>
            </div>
          );
        }

        // â”€â”€ äº‘åŒæ­¥è®¾ç½®é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function CloudSettings({ gistConfig, setGistConfig, onSync, syncStatus, lastSyncTime }) {
          const [showToken, setShowToken] = useState(false);
          const [isEditing, setIsEditing] = useState(!gistConfig.token);

          const handleSave = () => {
            saveToStorage('gist_config', gistConfig);
            setIsEditing(false);
          };

          const handleTest = async () => {
            onSync('testing');
          };

          return (
            <div style={{background:"white", borderRadius:16, padding:16, border:"1px solid #E5E7EB", marginBottom:16}}>
              <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:12}}>
                <div style={{fontSize:14, fontWeight:700, display:"flex", alignItems:"center", gap:6}}>
                  <span>â˜ï¸</span> GitHub äº‘åŒæ­¥
                </div>
                <div style={{display:"flex", gap:8}}>
                  {syncStatus === 'syncing' && <span style={{fontSize:12, color:"#6B7280"}}>â³ åŒæ­¥ä¸­...</span>}
                  {syncStatus === 'success' && <span style={{fontSize:12, color:"#2D6A4F"}}>âœ… å·²åŒæ­¥</span>}
                  {syncStatus === 'error' && <span style={{fontSize:12, color:"#DC2626"}}>âŒ å¤±è´¥</span>}
                  {syncStatus === 'offline' && <span style={{fontSize:12, color:"#F59E0B"}}>ğŸ“´ ç¦»çº¿</span>}
                </div>
              </div>

              {isEditing ? (
                <div>
                  <div style={{fontSize:12, color:"#6B7280", marginBottom:8, lineHeight:1.5}}>
                    é…ç½® GitHub Gist å®ç°æ•°æ®äº‘åŒæ­¥ï¼Œæ¢è®¾å¤‡ä¹Ÿèƒ½è®¿é—®ã€‚
                    <a href="#" onClick={(e)=>{e.preventDefault();alert('1. è®¿é—® github.com/settings/tokens\n2. ç”Ÿæˆ Personal access token (classic)\n3. å‹¾é€‰ gist æƒé™\n4. å¤åˆ¶ Token åˆ°ä¸‹æ–¹');}} style={{color:"#2D6A4F", marginLeft:4}}>å¦‚ä½•è·å–?</a>
                  </div>
                  <input 
                    type={showToken ? "text" : "password"}
                    placeholder="GitHub Personal Access Token"
                    value={gistConfig.token}
                    onChange={e=>setGistConfig({...gistConfig, token: e.target.value})}
                    style={{width:"100%", padding:10, border:"1.5px solid #E5E7EB", borderRadius:8, fontSize:13, marginBottom:8, fontFamily:"monospace"}}
                  />
                  <input 
                    type="text"
                    placeholder="Gist ID (å¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨åˆ›å»º)"
                    value={gistConfig.gistId}
                    onChange={e=>setGistConfig({...gistConfig, gistId: e.target.value.trim()})}
                    style={{width:"100%", padding:10, border:"1.5px solid #E5E7EB", borderRadius:8, fontSize:13, marginBottom:12, fontFamily:"monospace"}}
                  />
                  <div style={{display:"flex", gap:8}}>
                    <button onClick={handleSave} style={{flex:1, padding:10, background:"#2D6A4F", color:"white", border:"none", borderRadius:8, fontSize:13, fontWeight:700}}>ä¿å­˜é…ç½®</button>
                    <button onClick={()=>setShowToken(!showToken)} style={{padding:10, background:"#F3F4F6", color:"#6B7280", border:"none", borderRadius:8, fontSize:13}}>{showToken ? "éšè—" : "æ˜¾ç¤º"}</button>
                  </div>
                </div>
              ) : (
                <div>
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", padding:"8px 0", borderBottom:"1px solid #F3F4F6"}}>
                    <span style={{fontSize:12, color:"#6B7280"}}>Token</span>
                    <span style={{fontSize:12, fontFamily:"monospace", background:"#F3F4F6", padding:"2px 8px", borderRadius:4}}>{gistConfig.token.slice(0,8)}...{gistConfig.token.slice(-4)}</span>
                  </div>
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", padding:"8px 0", borderBottom:"1px solid #F3F4F6"}}>
                    <span style={{fontSize:12, color:"#6B7280"}}>Gist ID</span>
                    <span style={{fontSize:12, fontFamily:"monospace", background:"#F3F4F6", padding:"2px 8px", borderRadius:4}}>{gistConfig.gistId || "æœªè®¾ç½®"}</span>
                  </div>
                  {lastSyncTime && (
                    <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", padding:"8px 0", borderBottom:"1px solid #F3F4F6"}}>
                      <span style={{fontSize:12, color:"#6B7280"}}>æœ€ååŒæ­¥</span>
                      <span style={{fontSize:12, color:"#6B7280"}}>{new Date(lastSyncTime).toLocaleString()}</span>
                    </div>
                  )}
                  <div style={{display:"flex", gap:8, marginTop:12}}>
                    <button onClick={()=>onSync('manual')} style={{flex:1, padding:10, background:"#2D6A4F", color:"white", border:"none", borderRadius:8, fontSize:13, fontWeight:700}}>ğŸ”„ ç«‹å³åŒæ­¥</button>
                    <button onClick={()=>setIsEditing(true)} style={{padding:10, background:"#F3F4F6", color:"#6B7280", border:"none", borderRadius:8, fontSize:13}}>ç¼–è¾‘</button>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // â”€â”€ ç®¡ç†é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function AdminPanel({ itinerary, setItinerary, personal, setPersonal, settings, setSettings, logs, setLogs, onClose, showToast, gistConfig, setGistConfig, syncStatus, lastSyncTime, triggerSync }) {
          const [activeTab, setActiveTab] = useState("itinerary");
          const cardStyle = {background:"white",borderRadius:16,padding:16,marginBottom:12,border:"1px solid #E5E7EB"};
          const inputStyle = {width:"100%",padding:10,border:"1.5px solid #E5E7EB",borderRadius:8,fontSize:14,marginBottom:10,display:"block",boxSizing:"border-box"};
          const updateItinerary = (id, field, val) => setItinerary(itinerary.map(item => item.id === id ? {...item, [field]: val} : item));
          const deleteItinerary = (id) => confirm("ç¡®å®šåˆ é™¤è¯¥ç«™ç‚¹å—ï¼Ÿ") && setItinerary(itinerary.filter(item => item.id !== id));
          const deleteLog = (id) => confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ") && setLogs(logs.filter(l => l.id !== id));

          return (
            <div style={{position:"fixed",inset:0,background:"#F8FAF9",zIndex:1000,overflowY:"auto",padding:"20px 16px 80px"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                <h2 style={{fontSize:20,fontWeight:800}}>âš™ï¸ ç®¡ç†ä¸­å¿ƒ</h2>
                <button onClick={onClose} style={{background:"#2D6A4F",color:"white",border:"none",borderRadius:8,padding:"8px 16px",fontSize:13,fontWeight:700}}>å®Œæˆé€€å‡º</button>
              </div>

              {/* äº‘åŒæ­¥è®¾ç½® */}
              <CloudSettings 
                gistConfig={gistConfig} 
                setGistConfig={setGistConfig}
                onSync={triggerSync}
                syncStatus={syncStatus}
                lastSyncTime={lastSyncTime}
              />

              <div style={{display:"flex",gap:4,marginBottom:20,background:"#E5E7EB",padding:4,borderRadius:12}}>
                {[["itinerary","è¡Œç¨‹"],["logs","è®°å½•"],["personal","ä¸ªäºº"]].map(([id,label])=>{
                  // ä¿®å¤ï¼šä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°è¿”å›æ­£ç¡®çš„ JSX
                  const isActive = activeTab === id;
                  return (
                    <button key={id} onClick={()=>setActiveTab(id)} style={{flex:1,padding:8,borderRadius:10,border:"none",background:isActive?"white":"transparent",color:isActive?"#2D6A4F":"#6B7280",fontSize:13,fontWeight:700}}>
                      {label}
                    </button>
                  );
                })}
              </div>
              {activeTab === "itinerary" && (
                <div>
                  {itinerary.map((item, idx) => (
                    <div key={item.id} style={cardStyle}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:10,alignItems:"center"}}>
                        <span style={{fontWeight:700,fontSize:14}}>ç«™ç‚¹ {idx+1}</span>
                        <div style={{display:"flex",gap:8}}>
                          <select value={item.status} onChange={e=>updateItinerary(item.id, "status", e.target.value)} style={{fontSize:12,border:"1px solid #ccc",borderRadius:4,padding:2}}>
                            <option value="done">å·²å®Œæˆ</option><option value="now">ç°åœ¨</option><option value="next">è®¡åˆ’</option>
                          </select>
                          <button onClick={()=>deleteItinerary(item.id)} style={{background:"#FEE2E2",color:"#DC2626",border:"none",borderRadius:4,padding:"2px 8px",fontSize:12}}>åˆ é™¤</button>
                        </div>
                      </div>
                      <input style={inputStyle} value={item.country} onChange={e=>updateItinerary(item.id, "country", e.target.value)} placeholder="åŸå¸‚/å›½å®¶"/>
                      <div style={{display:"flex",gap:8}}>
                        <input style={{...inputStyle, flex:1}} value={item.flag} onChange={e=>updateItinerary(item.id, "flag", e.target.value)} placeholder="Emoji"/>
                        <input style={{...inputStyle, flex:2}} value={item.dates} onChange={e=>updateItinerary(item.id, "dates", e.target.value)} placeholder="æ—¥æœŸ (å¦‚: 2.17-2.20)"/>
                      </div>
                    </div>
                  ))}
                  <button onClick={()=>setItinerary([...itinerary, {id:Date.now(), country:"", flag:"ğŸ“", dates:"", status:"next"}])} style={{width:"100%",padding:12,borderRadius:10,border:"2px dashed #2D6A4F",background:"none",color:"#2D6A4F",fontWeight:700}}>+ æ·»åŠ æ–°ç«™ç‚¹</button>
                </div>
              )}
              {activeTab === "logs" && (
                <div>
                  {logs.map((l) => (
                    <div key={l.id} style={{...cardStyle, padding:12, display:"flex", justifyContent:"space-between", alignItems:"center"}}>
                      <div><div style={{fontSize:14, fontWeight:700}}>{l.loc} Â· {l.time}</div><div style={{fontSize:12, color:"#6B7280"}}>{l.msg}</div></div>
                      <button onClick={()=>deleteLog(l.id)} style={{background:"#FEE2E2",color:"#DC2626",border:"none",borderRadius:6,padding:"6px 12px",fontSize:12}}>åˆ é™¤</button>
                    </div>
                  ))}
                </div>
              )}
              {activeTab === "personal" && (
                <div style={cardStyle}>
                  <label style={{fontSize:12,color:"#6B7280"}}>å§“å</label><input style={inputStyle} value={personal.name} onChange={e=>setPersonal({...personal, name:e.target.value})}/>
                  <label style={{fontSize:12,color:"#6B7280"}}>æŠ¤ç…§å·</label><input style={inputStyle} value={personal.passport} onChange={e=>setPersonal({...personal, passport:e.target.value})}/>
                  <label style={{fontSize:12,color:"#6B7280"}}>ç´§æ€¥è”ç³»äºº</label><input style={inputStyle} value={settings.contactName} onChange={e=>setSettings({...settings, contactName:e.target.value})}/>
                  <label style={{fontSize:12,color:"#6B7280"}}>è”ç³»ç”µè¯</label><input style={inputStyle} value={settings.contactPhone} onChange={e=>setSettings({...settings, contactPhone:e.target.value})}/>
                </div>
              )}
            </div>
          );
        }

        // â”€â”€ ä¸»åº”ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function App() {
          const [role, setRole] = useState(null);
          const [tab, setTab] = useState("map");
          const [itinerary, setItinerary] = useState(DEFAULT_ITINERARY);
          const [personal, setPersonal] = useState(DEFAULT_PERSONAL);
          const [settings, setSettings] = useState(DEFAULT_SETTINGS);
          const [logs, setLogs] = useState(INIT_LOGS);

          // äº‘åŒæ­¥çŠ¶æ€
          const [gistConfig, setGistConfig] = useState(() => loadFromStorage('gist_config', { token: '', gistId: '' }));
          const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error, offline
          const [lastSyncTime, setLastSyncTime] = useState(null);
          const [isInitialLoad, setIsInitialLoad] = useState(true);

          const [toast, setToast] = useState(null);
          const [checkinModal, setCheckinModal] = useState(false);
          const [checkinMode, setCheckinMode] = useState("quick");
          const [showAdmin, setShowAdmin] = useState(false);
          const [pw, setPw] = useState("");
          const [shake, setShake] = useState(false);

          const [locationName, setLocationName] = useState("");
          const [message, setMessage] = useState("");
          const [gpsCoords, setGpsCoords] = useState(null);
          const [gpsLoading, setGpsLoading] = useState(false);
          const [photoPreview, setPhotoPreview] = useState(null);
          const [showMapPicker, setShowMapPicker] = useState(false);
          const fileInputRef = useRef(null);

          // æ˜¾ç¤ºæç¤º
          const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

          // åŒæ­¥æ•°æ®åˆ° Gist
          const syncToGist = useCallback(async (showNotification = true) => {
            if (!gistConfig.token) {
              if (showNotification) showToast('âš ï¸ è¯·å…ˆé…ç½® GitHub Token');
              return;
            }

            setSyncStatus('syncing');
            const dataToSync = {
              itinerary,
              personal,
              settings,
              logs,
              lastSync: new Date().toISOString()
            };

            try {
              let gistId = gistConfig.gistId;

              // å¦‚æœæ²¡æœ‰ Gist IDï¼Œåˆ›å»ºæ–°çš„
              if (!gistId) {
                const newGist = await GistAPI.createGist(gistConfig.token, dataToSync);
                gistId = newGist.id;
                setGistConfig(prev => {
                  const updated = { ...prev, gistId };
                  saveToStorage('gist_config', updated);
                  return updated;
                });
                if (showNotification) showToast('âœ… å·²åˆ›å»ºæ–°çš„äº‘å¤‡ä»½');
              } else {
                // æ›´æ–°ç°æœ‰ Gist
                await GistAPI.updateGist(gistId, gistConfig.token, dataToSync);
                if (showNotification) showToast('âœ… å·²åŒæ­¥åˆ°äº‘ç«¯');
              }

              setLastSyncTime(Date.now());
              setSyncStatus('success');
              saveToStorage('last_sync_time', Date.now());
            } catch (error) {
              console.error('Sync error:', error);
              setSyncStatus('error');
              if (showNotification) showToast('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }
          }, [itinerary, personal, settings, logs, gistConfig]);

          // ä» Gist åŠ è½½æ•°æ®
          const loadFromGist = useCallback(async () => {
            if (!gistConfig.token || !gistConfig.gistId) {
              setIsInitialLoad(false);
              return;
            }

            setSyncStatus('syncing');
            try {
              const data = await GistAPI.fetchGist(gistConfig.gistId, gistConfig.token);
              if (data) {
                if (data.itinerary) setItinerary(data.itinerary);
                if (data.personal) setPersonal(data.personal);
                if (data.settings) setSettings(data.settings);
                if (data.logs) setLogs(data.logs);
                setLastSyncTime(Date.now());
                setSyncStatus('success');
                showToast('â˜ï¸ å·²ä»äº‘ç«¯æ¢å¤æ•°æ®');
              }
            } catch (error) {
              console.error('Load error:', error);
              setSyncStatus('error');
              showToast('âš ï¸ ä»äº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
            }
            setIsInitialLoad(false);
          }, [gistConfig]);

          // é¦–æ¬¡åŠ è½½ï¼šå…ˆå°è¯•ä» Gist åŠ è½½ï¼Œå¦åˆ™ä» localStorage åŠ è½½
          useEffect(() => {
            const init = async () => {
              if (gistConfig.token && gistConfig.gistId) {
                await loadFromGist();
              } else {
                // ä» localStorage åŠ è½½
                setItinerary(loadFromStorage("travel_itinerary_v7", DEFAULT_ITINERARY));
                setPersonal(loadFromStorage("travel_personal_v7", DEFAULT_PERSONAL));
                setSettings(loadFromStorage("travel_settings_v7", DEFAULT_SETTINGS));
                setLogs(loadFromStorage("travel_logs_v7", INIT_LOGS));
                setLastSyncTime(loadFromStorage('last_sync_time', null));
                setIsInitialLoad(false);
              }
            };
            init();
          }, []);

          // æ•°æ®å˜åŒ–æ—¶ä¿å­˜åˆ° localStorage å¹¶è‡ªåŠ¨åŒæ­¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
          useEffect(() => {
            if (isInitialLoad) return;

            saveToStorage("travel_itinerary_v7", itinerary);
            saveToStorage("travel_personal_v7", personal);
            saveToStorage("travel_settings_v7", settings);
            saveToStorage("travel_logs_v7", logs);

            // è‡ªåŠ¨åŒæ­¥ï¼ˆå¦‚æœå·²é…ç½®ä¸”ä¸æ˜¯ç¦»çº¿çŠ¶æ€ï¼‰
            if (gistConfig.token && gistConfig.gistId && syncStatus !== 'offline') {
              const timeout = setTimeout(() => {
                syncToGist(false); // é™é»˜åŒæ­¥ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
              }, 2000); // å»¶è¿Ÿ 2 ç§’ï¼Œé¿å…é¢‘ç¹æ“ä½œè§¦å‘å¤ªå¤šè¯·æ±‚
              return () => clearTimeout(timeout);
            }
          }, [itinerary, personal, settings, logs, isInitialLoad]);

          // ç›‘å¬ç½‘ç»œçŠ¶æ€
          useEffect(() => {
            const handleOnline = () => {
              if (syncStatus === 'offline') {
                setSyncStatus('idle');
                syncToGist(false);
              }
            };
            const handleOffline = () => setSyncStatus('offline');

            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            return () => {
              window.removeEventListener('online', handleOnline);
              window.removeEventListener('offline', handleOffline);
            };
          }, [syncStatus, syncToGist]);

          // å¤„ç†è§£é”
          const handleUnlock = () => {
            if (pw === ADMIN_PASSWORD) { setRole("admin"); showToast("ç®¡ç†å‘˜å·²ç™»å½•"); }
            else if (pw === VIEWER_PASSWORD) { setRole("viewer"); showToast("æŸ¥çœ‹æ¨¡å¼å·²å¼€å¯"); }
            else { setShake(true); setTimeout(() => setShake(false), 500); }
            setPw("");
          };

          // å¤„ç†ç…§ç‰‡é€‰æ‹©
          const handlePhotoSelect = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => setPhotoPreview(reader.result);
            reader.readAsDataURL(file);
          };

          // ç¡®è®¤ç­¾åˆ°ï¼ˆä»…ç®¡ç†å‘˜å¯ç”¨ï¼‰
          const confirmCheckin = (isQuick = false) => {
            if (role !== "admin") {
              showToast("âš ï¸ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰“å¡");
              return;
            }
            const now = new Date();
            const timeStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}`;
            const current = itinerary.find(x => x.status === "now") || {country: "æ—…é€”ä¸­"};
            const newLog = { 
              id: Date.now(), 
              loc: isQuick ? current.country : (locationName || current.country), 
              msg: isQuick ? "æˆ‘å¾ˆå®‰å…¨ï¼Œä¸€åˆ‡æ­£å¸¸" : (message || "æ­£å¸¸ç­¾åˆ°"), 
              time: timeStr, 
              lat: gpsCoords?.lat || null, 
              lng: gpsCoords?.lng || null, 
              photo: photoPreview || null,
              likes: 0,
              comments: []
            };
            setLogs([newLog, ...logs]);
            setCheckinModal(false); setGpsCoords(null); setPhotoPreview(null); setLocationName(""); setMessage("");
            showToast("âœ… ç­¾åˆ°æˆåŠŸ");
          };

          // ç‚¹èµåŠŸèƒ½ï¼ˆæŸ¥çœ‹è€…å¯ç”¨ï¼‰
          const handleLike = (logId) => {
            setLogs(logs.map(log => 
              log.id === logId 
                ? { ...log, likes: (log.likes || 0) + 1 }
                : log
            ));
            showToast("â¤ï¸ ç‚¹èµæˆåŠŸ");
          };

          // æ·»åŠ è¯„è®ºï¼ˆæŸ¥çœ‹è€…å¯ç”¨ï¼‰
          const [commentModal, setCommentModal] = useState(false);
          const [currentLogId, setCurrentLogId] = useState(null);
          const [commentText, setCommentText] = useState("");

          const openCommentModal = (logId) => {
            setCurrentLogId(logId);
            setCommentText("");
            setCommentModal(true);
          };

          const submitComment = () => {
            if (!commentText.trim()) {
              showToast("âš ï¸ è¯·è¾“å…¥è¯„è®ºå†…å®¹");
              return;
            }
            const now = new Date();
            const timeStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}`;

            setLogs(logs.map(log => 
              log.id === currentLogId 
                ? { 
                    ...log, 
                    comments: [...(log.comments || []), { 
                      id: Date.now(), 
                      text: commentText, 
                      time: timeStr,
                      author: role === "admin" ? "æ—…è¡Œè€…" : "å®¶äºº"
                    }]
                  }
                : log
            ));
            setCommentModal(false);
            setCommentText("");
            showToast("ğŸ’¬ è¯„è®ºå·²æ·»åŠ ");
          };

          // è§¦å‘åŒæ­¥ï¼ˆä¾›å­ç»„ä»¶è°ƒç”¨ï¼‰
          const triggerSync = (type) => {
            if (type === 'testing') {
              // æµ‹è¯•è¿æ¥
              syncToGist(true);
            } else {
              syncToGist(true);
            }
          };

          const c = { primary:"#2D6A4F", light:"#52B788", pale:"#D8F3DC", accent:"#FF6B35", danger:"#E63946", muted:"#6B7280", border:"#E5E7EB", bg:"#F8FAF9" };

          if (!role) return (
            <div style={{minHeight:"100vh",background:"linear-gradient(160deg,#1B4332 0%,#2D6A4F 50%,#40916C 100%)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24,animation:shake?"shake 0.5s":""}}>
              <div style={{fontSize:56,marginBottom:16}}>ğŸŒ</div>
              <div style={{color:"white",fontSize:22,fontWeight:700,marginBottom:32}}>æ—…è¡Œå®‰å…¨ä¸­å¿ƒ</div>
              <div style={{width:"100%",maxWidth:280,textAlign:"center"}}>
                <input
                  type="password"
                  value={pw}
                  onChange={(e) => setPw(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleUnlock()}
                  placeholder="è¯·è¾“å…¥å¯†ç è§£é”"
                  style={{
                    width: "100%",
                    padding: 14,
                    borderRadius: 12,
                    border: "none",
                    marginBottom: 16,
                    fontSize: 16,
                    textAlign: "center",
                    outline: "none"
                  }}
                />
                <button
                  onClick={handleUnlock}
                  style={{
                    width: "100%",
                    padding: 14,
                    borderRadius: 12,
                    border: "none",
                    background: "#FFFFFF",
                    color: "#2D6A4F",
                    fontSize: 16,
                    fontWeight: 700,
                    cursor: "pointer"
                  }}
                >
                  è§£é”è®¿é—®
                </button>
              </div>
            </div>
          );

          // æ ¸å¿ƒåŠŸèƒ½åŒºï¼ˆè§£é”åæ˜¾ç¤ºï¼‰
          return (
            <div style={{minHeight:"100vh",background:c.bg,padding:16}}>
              {/* Toast æç¤º */}
              {toast && (
                <div style={{
                  position: "fixed",
                  top: 20,
                  left: "50%",
                  transform: "translateX(-50%)",
                  background: "white",
                  padding: 12,
                  borderRadius: 8,
                  boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                  zIndex: 9999,
                  fontSize: 14,
                  fontWeight: 500
                }}>
                  {toast}
                </div>
              )}

              {/* é¡¶éƒ¨å¯¼èˆª */}
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                <h1 style={{fontSize:18,fontWeight:800,color:c.primary}}>æ—…è¡Œå®‰å…¨ä¸­å¿ƒ</h1>
                {role === "admin" && (
                  <button onClick={() => setShowAdmin(true)} style={{background:c.primary,color:"white",border:"none",borderRadius:8,padding:"8px 12px",fontSize:12,fontWeight:700}}>
                    âš™ï¸ ç®¡ç†
                  </button>
                )}
              </div>

              {/* æ ‡ç­¾åˆ‡æ¢ */}
              <div style={{display:"flex",gap:4,marginBottom:20,background:c.border,padding:4,borderRadius:12}}>
                {[["map","åœ°å›¾"],["log","åŠ¨æ€"],["info","ä¿¡æ¯"]].map(([id,label])=>{
                  const isActive = tab === id;
                  return (
                    <button key={id} onClick={()=>setTab(id)} style={{flex:1,padding:8,borderRadius:10,border:"none",background:isActive?"white":"transparent",color:isActive?c.primary:c.muted,fontSize:13,fontWeight:700}}>
                      {label}
                    </button>
                  );
                })}
              </div>

              {/* åœ°å›¾æ ‡ç­¾ */}
              {tab === "map" && (
                <div>
                  {itinerary.map(item => (
                    <div key={item.id} style={{background:"white",borderRadius:16,padding:16,marginBottom:12,border:`1px solid ${item.status === "now" ? c.light : c.border}`}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                        <div style={{display:"flex",alignItems:"center",gap:8}}>
                          <span style={{fontSize:20}}>{item.flag}</span>
                          <span style={{fontSize:16,fontWeight:700}}>{item.country}</span>
                        </div>
                        <span style={{fontSize:12,color:c.muted}}>{item.dates}</span>
                      </div>
                      <StaticMap lat={item.lat} lng={item.lng} />
                      {item.status === "now" && role === "admin" && (
                        <button 
                          onClick={() => setCheckinModal(true)}
                          style={{width:"100%",marginTop:12,padding:10,background:c.accent,color:"white",border:"none",borderRadius:8,fontSize:14,fontWeight:700,cursor:"pointer"}}
                        >
                          ğŸ“ å¿«é€Ÿç­¾åˆ°
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* åŠ¨æ€æ ‡ç­¾ */}
              {tab === "log" && (
                <div>
                  {logs.map(log => (
                    <div key={log.id} style={{background:"white",borderRadius:16,padding:16,marginBottom:12,border:"1px solid c.border"}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                        <div style={{fontSize:14,fontWeight:700}}>{log.loc} Â· {log.time}</div>
                        <div style={{display:"flex",alignItems:"center",gap:8}}>
                          <button onClick={() => handleLike(log.id)} style={{background:"none",border:"none",color:c.accent,cursor:"pointer",display:"flex",alignItems:"center",gap:2}}>
                            â¤ï¸ {log.likes || 0}
                          </button>
                          <button onClick={() => openCommentModal(log.id)} style={{background:"none",border:"none",color:c.muted,cursor:"pointer"}}>ğŸ’¬</button>
                        </div>
                      </div>
                      <div style={{fontSize:14,marginBottom:12}}>{log.msg}</div>
                      {log.lat && log.lng && <StaticMap lat={log.lat} lng={log.lng} height={120} />}
                      {log.comments && log.comments.length > 0 && (
                        <div style={{marginTop:12,paddingTop:12,borderTop:"1px solid #f0f0f0"}}>
                          <div style={{fontSize:12,color:c.muted,marginBottom:8}}>è¯„è®ºåŒº</div>
                          {log.comments.map(comment => (
                            <div key={comment.id} style={{background:c.pale,padding:8,borderRadius:8,marginBottom:6}}>
                              <div style={{fontSize:11,color:c.muted}}>{comment.author} Â· {comment.time}</div>
                              <div style={{fontSize:13}}>{comment.text}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* ä¿¡æ¯æ ‡ç­¾ */}
              {tab === "info" && (
                <div style={{background:"white",borderRadius:16,padding:16,border:"1px solid c.border"}}>
                  <div style={{fontSize:16,fontWeight:700,marginBottom:16,color:c.primary}}>ğŸ“‹ ä¸ªäººåº”æ€¥ä¿¡æ¯</div>
                  <div style={{display:"flex",flexDirection:"column",gap:12}}>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>å§“å</span>
                      <span>{personal.name || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>æŠ¤ç…§å·</span>
                      <span>{personal.passport || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>è¡€å‹</span>
                      <span>{personal.blood || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>è¿‡æ•å²</span>
                      <span>{personal.allergy || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>ä¿é™©å•å·</span>
                      <span>{personal.insurance || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>ä¿é™©å…¬å¸ç”µè¯</span>
                      <span>{personal.insPhone || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>é¢„è®¡è¿”ç¨‹æ—¥æœŸ</span>
                      <span>{personal.returnDate || "æœªå¡«å†™"}</span>
                    </div>
                    <div style={{display:"flex",justifyContent:"space-between"}}>
                      <span style={{color:c.muted}}>ç´§æ€¥è”ç³»äºº</span>
                      <span>{settings.contactName} ({settings.contactPhone})</span>
                    </div>
                  </div>
                </div>
              )}

              {/* ç­¾åˆ°å¼¹çª— */}
              {checkinModal && (
                <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:999}}>
                  <div style={{background:"white",borderRadius:16,padding:20,width:"90%",maxWidth:400}}>
                    <div style={{fontSize:18,fontWeight:700,marginBottom:16,color:c.primary}}>ğŸ“ ç­¾åˆ°æ‰“å¡</div>
                    <div style={{display:"flex",gap:4,marginBottom:16,background:c.border,padding:4,borderRadius:8}}>
                      <button onClick={()=>setCheckinMode("quick")} style={{flex:1,padding:6,borderRadius:6,border:"none",background:checkinMode==="quick"?"white":"transparent",color:checkinMode==="quick"?c.primary:c.muted,fontSize:12}}>å¿«é€Ÿç­¾åˆ°</button>
                      <button onClick={()=>setCheckinMode("custom")} style={{flex:1,padding:6,borderRadius:6,border:"none",background:checkinMode==="custom"?"white":"transparent",color:checkinMode==="custom"?c.primary:c.muted,fontSize:12}}>è‡ªå®šä¹‰</button>
                    </div>
                    {checkinMode === "custom" && (
                      <div style={{display:"flex",flexDirection:"column",gap:12}}>
                        <input
                          value={locationName}
                          onChange={(e)=>setLocationName(e.target.value)}
                          placeholder="å½“å‰ä½ç½®ï¼ˆå¦‚ï¼šæ›¼è°·å¸‚åŒºï¼‰"
                          style={{padding:10,border:`1px solid ${c.border}`,borderRadius:8,fontSize:14}}
                        />
                        <textarea
                          value={message}
                          onChange={(e)=>setMessage(e.target.value)}
                          placeholder="æƒ³è¯´çš„è¯ï¼ˆå¦‚ï¼šä¸€åˆ‡å®‰å¥½ï¼Œæ”¾å¿ƒï¼ï¼‰"
                          rows={3}
                          style={{padding:10,border:`1px solid ${c.border}`,borderRadius:8,fontSize:14,resize:"none"}}
                        />
                        <div>
                          <div style={{fontSize:12,color:c.muted,marginBottom:8}}>ä½ç½®å®šä½</div>
                          {!showMapPicker ? (
                            <div style={{display:"flex",gap:8}}>
                              <button 
                                onClick={()=>{
                                  setGpsLoading(true);
                                  if (navigator.geolocation) {
                                    navigator.geolocation.getCurrentPosition(
                                      (pos) => {
                                        setGpsCoords({lat: pos.coords.latitude, lng: pos.coords.longitude});
                                        setGpsLoading(false);
                                        showToast("ğŸ“ å®šä½æˆåŠŸ");
                                      },
                                      (err) => {
                                        setGpsLoading(false);
                                        showToast("âŒ å®šä½å¤±è´¥ï¼š" + err.message);
                                      }
                                    );
                                  } else {
                                    setGpsLoading(false);
                                    showToast("âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
                                  }
                                }}
                                style={{flex:1,padding:8,borderRadius:8,border:"none",background:c.pale,color:c.primary,fontSize:12}}
                              >
                                {gpsLoading ? "ğŸ”„ å®šä½ä¸­..." : "ğŸ“± è‡ªåŠ¨å®šä½"}
                              </button>
                              <button onClick={()=>setShowMapPicker(true)} style={{flex:1,padding:8,borderRadius:8,border:"none",background:c.pale,color:c.primary,fontSize:12}}>ğŸ—ºï¸ æ‰‹åŠ¨é€‰æ‹©</button>
                            </div>
                          ) : (
                            <MapPicker 
                              initLat={gpsCoords?.lat || 13.75} 
                              initLng={gpsCoords?.lng || 100.49}
                              onPick={(lat, lng) => {
                                setGpsCoords({lat, lng});
                                setShowMapPicker(false);
                              }}
                            />
                          )}
                          {gpsCoords && (
                            <div style={{fontSize:11,color:c.muted,marginTop:8}}>
                              å·²é€‰ä½ç½®ï¼š{gpsCoords.lat.toFixed(4)}, {gpsCoords.lng.toFixed(4)}
                            </div>
                          )}
                        </div>
                        <div>
                          <div style={{fontSize:12,color:c.muted,marginBottom:8}}>ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</div>
                          <div style={{display:"flex",gap:8}}>
                            <input
                              type="file"
                              accept="image/*"
                              ref={fileInputRef}
                              onChange={handlePhotoSelect}
                              style={{display:"none"}}
                            />
                            <button onClick={()=>fileInputRef.current.click()} style={{flex:1,padding:8,borderRadius:8,border:"none",background:c.pale,color:c.primary,fontSize:12}}>
                              ğŸ“· é€‰æ‹©ç…§ç‰‡
                            </button>
                          </div>
                          {photoPreview && (
                            <div style={{marginTop:8}}>
                              <img src={photoPreview} alt="é¢„è§ˆ" style={{width:"100%",height:120,objectFit:"cover",borderRadius:8}} />
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    <div style={{display:"flex",gap:8,marginTop:20}}>
                      <button onClick={()=>setCheckinModal(false)} style={{flex:1,padding:10,borderRadius:8,border:`1px solid ${c.border}`,background:"none",color:c.muted,fontSize:14}}>å–æ¶ˆ</button>
                      <button onClick={()=>confirmCheckin(checkinMode==="quick")} style={{flex:1,padding:10,borderRadius:8,border:"none",background:c.primary,color:"white",fontSize:14,fontWeight:700}}>ç¡®è®¤ç­¾åˆ°</button>
                    </div>
                  </div>
                </div>
              )}

              {/* è¯„è®ºå¼¹çª— */}
              {commentModal && (
                <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:999}}>
                  <div style={{background:"white",borderRadius:16,padding:20,width:"90%",maxWidth:400}}>
                    <div style={{fontSize:18,fontWeight:700,marginBottom:16,color:c.primary}}>ğŸ’¬ å‘è¡¨è¯„è®º</div>
                    <textarea
                      value={commentText}
                      onChange={(e)=>setCommentText(e.target.value)}
                      placeholder="è¾“å…¥ä½ çš„è¯„è®º..."
                      rows={3}
                      style={{padding:10,border:`1px solid ${c.border}`,borderRadius:8,fontSize:14,resize:"none",width:"100%",marginBottom:16}}
                    />
                    <div style={{display:"flex",gap:8}}>
                      <button onClick={()=>setCommentModal(false)} style={{flex:1,padding:10,borderRadius:8,border:`1px solid ${c.border}`,background:"none",color:c.muted,fontSize:14}}>å–æ¶ˆ</button>
                      <button onClick={submitComment} style={{flex:1,padding:10,borderRadius:8,border:"none",background:c.primary,color:"white",fontSize:14,fontWeight:700}}>å‘é€</button>
                    </div>
                  </div>
                </div>
              )}

              {/* ç®¡ç†é¢æ¿ */}
              {showAdmin && (
                <AdminPanel 
                  itinerary={itinerary}
                  setItinerary={setItinerary}
                  personal={personal}
                  setPersonal={setPersonal}
                  settings={settings}
                  setSettings={setSettings}
                  logs={logs}
                  setLogs={setLogs}
                  onClose={()=>setShowAdmin(false)}
                  showToast={showToast}
                  gistConfig={gistConfig}
                  setGistConfig={setGistConfig}
                  syncStatus={syncStatus}
                  lastSyncTime={lastSyncTime}
                  triggerSync={triggerSync}
                />
              )}
            </div>
          );
        }

        // ä¿®å¤æ ¸å¿ƒï¼šæŒ‚è½½ App ç»„ä»¶åˆ° #root èŠ‚ç‚¹
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
      </script>
</body>
</html>
